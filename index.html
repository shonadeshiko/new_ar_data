<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ä½ç½®å›ºå®šARãƒã‚¹ã‚¿ãƒ¼ï¼ˆå®‰å®šç‰ˆï¼‰</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: sans-serif;
    }
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ar-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    #debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 11px;
      font-family: monospace;
      max-width: 90%;
    }
    #button-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 30px;
      border-radius: 15px;
      z-index: 2000;
      text-align: center;
      max-width: 80%;
    }
    .button {
      padding: 15px 30px;
      font-size: 16px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
      display: block;
      width: 100%;
    }
    .button:active {
      background: #0051D5;
    }
    .button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    .success {
      color: #0f0;
      margin: 10px 0;
    }
    .error {
      color: #f00;
      margin: 10px 0;
    }
    .ok { color: #0f0; }
    .warn { color: #ff0; }
    .err { color: #f00; }
  </style>
</head>
<body>
  
  <div id="button-panel">
    <h2>ğŸ“± ARã®æº–å‚™</h2>
    <p id="status-message">ARã‚’å§‹ã‚ã‚‹ã«ã¯3ã¤ã®è¨±å¯ãŒå¿…è¦ã§ã™</p>
    
    <button id="start-button" class="button" onclick="startCamera()">
      1ï¸âƒ£ ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
    </button>
    
    <button id="gps-button" class="button" onclick="startGPS()" disabled>
      2ï¸âƒ£ ä½ç½®æƒ…å ±ã‚’å–å¾—
    </button>
    
    <button id="gyro-button" class="button" onclick="requestGyro()" disabled>
      3ï¸âƒ£ ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹åŒ–
    </button>
    
    <button id="close-button" class="button" onclick="closePanel()" disabled style="background:#28a745;">
      âœ… ARã‚’é–‹å§‹
    </button>
  </div>
  
  <div id="video-container">
    <video id="camera-feed" autoplay playsinline></video>
  </div>
  
  <canvas id="ar-canvas"></canvas>
  
  <div id="debug-info">
    <div><strong>ğŸ“± ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆå®‰å®šç‰ˆï¼‰</strong></div>
    <div>GPS: <span id="gps-status">å¾…æ©Ÿä¸­</span></div>
    <div>ä½ç½®: <span id="position">--</span></div>
    <div>æ–¹ä½: <span id="heading">--</span>Â°</div>
    <div>ç”»åƒ: <span id="image-status">èª­è¾¼ä¸­</span></div>
    <div>è¡¨ç¤ºç¯„å›²: 30m</div>
    <div>è¡¨ç¤ºä¸­: <span id="visible-count" class="warn">0</span>å€‹</div>
    <div style="margin-top: 5px; color: #FF9500;">--- ID 13/14/15 ãƒ‡ãƒãƒƒã‚° ---</div>
    <div style="color: #FF9500;">ID13è·é›¢: <span id="dist-13">--</span>m</div>
    <div style="color: #FF9500;">ID14è·é›¢: <span id="dist-14">--</span>m</div>
     <div style="color: #FF9500;">ID15è·é›¢: <span id="dist-15">--</span>m</div>
  </div>

  <script>
    // 12ç®‡æ‰€ã®ãƒã‚¹ã‚¿ãƒ¼åº§æ¨™
    const posters = [
      {id: 1, lat: 35.683433, lon:  139.990745, height: 3.5, facing: 0},
      {id: 2, lat: 35.683378, lon: 139.991608, height: 2.0, facing: 0},
      {id: 3, lat: 35.683715, lon: 139.992265, height: 2.82, facing: 180},
      {id: 4, lat: 35.6833621, lon: 139.992847, height: 3.00, facing: 180},
      {id: 5, lat: 35.6834128284039, lon: 139.99271517352076, height: 2.5, facing: 315},
      {id: 6, lat: 35.683182908695876, lon: 139.9933211238243, height: 5.5, facing: 315},
      {id: 7, lat: 35.68303389035569, lon: 139.99362150270346, height: 5.5, facing: 315},
      {id: 8, lat: 35.68287023595939,  lon: 139.993966031626, height: 5.5, facing: 315},
      {id: 9, lat: 35.682720661114104, lon:  139.9942262253935, height: 5.5, facing: 315},
      {id: 10, lat: 35.68259716727719, lon: 139.99457674154323, height: 5.5, facing: 315},
      {id: 11, lat: 35.682452, lon: 139.994843, height: 2.8, facing: 300},
      {id: 12, lat: 35.683590, lon: 139.992799, height: 6.5, facing: 0},
      {id: 13, lat: 35.69432243174469, lon: 139.76166640019622, height: 5.5, facing: 90},
      {id: 14, lat: 35.69432243174469, lon: 139.76166640019622, height: 2.00, facing: 90},
      {id: 15, lat: 35.683612038601055, lon: 139.98979916453789, height: 10.00, facing: null}
    ];

    let userLat = null;
    let userLon = null;
    let heading = 0;
    let canvas, ctx;
    let posterImage = null;
    let headingAvailable = false;
    
    // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ç”¨ã®å¤‰æ•°
    let smoothedLat = null;
    let smoothedLon = null;
    let smoothedHeading = null;
    let headingHistory = [];
    let positionHistory = [];
    
    // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã®è¨­å®š
    const HEADING_HISTORY_SIZE = 5;  // æ–¹ä½ã®ç§»å‹•å¹³å‡ã«ä½¿ã†ã‚µãƒ³ãƒ—ãƒ«æ•°
    const POSITION_HISTORY_SIZE = 3; // ä½ç½®ã®ç§»å‹•å¹³å‡ã«ä½¿ã†ã‚µãƒ³ãƒ—ãƒ«æ•°
    
    const DISPLAY_RANGE = 0.0003;  // ç´„30mä»¥å†…
    const CAMERA_FOV = 70;
    
    // ãƒã‚¹ã‚¿ãƒ¼ç”»åƒã‚’èª­ã¿è¾¼ã¿
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      posterImage = img;
      document.getElementById('image-status').innerHTML = '<span class="ok">OK</span>';
    };
    img.onerror = () => {
      document.getElementById('image-status').innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼</span>';
    };
    img.src = 'poster.jpg';
    
    // è·é›¢è¨ˆç®—
    function calculateDistanceDegree(lat1, lon1, lat2, lon2) {
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      return Math.sqrt(dLat * dLat + dLon * dLon);
    }
    
    function degreeToMeter(degree) {
      return degree * 100000;
    }
    
    // æ–¹ä½è§’è¨ˆç®—
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = lon2 - lon1;
      const dLat = lat2 - lat1;
      const Î¸ = Math.atan2(dLon, dLat);
      return (Î¸ * 180 / Math.PI + 360) % 360;
    }
    
    // æ–¹ä½ã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆè§’åº¦ã®ç‰¹æ€§ã‚’è€ƒæ…®ã—ãŸç§»å‹•å¹³å‡ï¼‰
    function smoothHeading(newHeading) {
      headingHistory.push(newHeading);
      if (headingHistory.length > HEADING_HISTORY_SIZE) {
        headingHistory.shift();
      }
      
      if (headingHistory.length === 1) {
        smoothedHeading = newHeading;
        return smoothedHeading;
      }
      
      // è§’åº¦ã®å¹³å‡ã‚’è¨ˆç®—ï¼ˆå††å‘¨ä¸Šã®å¹³å‡ï¼‰
      let sumSin = 0;
      let sumCos = 0;
      headingHistory.forEach(h => {
        sumSin += Math.sin(h * Math.PI / 180);
        sumCos += Math.cos(h * Math.PI / 180);
      });
      
      const avgHeading = Math.atan2(sumSin, sumCos) * 180 / Math.PI;
      smoothedHeading = (avgHeading + 360) % 360;
      
      return smoothedHeading;
    }
    
    // ä½ç½®ã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆç§»å‹•å¹³å‡ï¼‰
    function smoothPosition(newLat, newLon) {
      positionHistory.push({lat: newLat, lon: newLon});
      if (positionHistory.length > POSITION_HISTORY_SIZE) {
        positionHistory.shift();
      }
      
      let sumLat = 0;
      let sumLon = 0;
      positionHistory.forEach(pos => {
        sumLat += pos.lat;
        sumLon += pos.lon;
      });
      
      smoothedLat = sumLat / positionHistory.length;
      smoothedLon = sumLon / positionHistory.length;
      
      return {lat: smoothedLat, lon: smoothedLon};
    }

    // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        
        document.getElementById('start-button').innerHTML = 'âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†';
        document.getElementById('start-button').disabled = true;
        document.getElementById('gps-button').disabled = false;
        
        showMessage('ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸ', 'success');
        
        canvas = document.getElementById('ar-canvas');
        ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
      } catch (err) {
        showMessage('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—2: GPSèµ·å‹•
    function startGPS() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          
          // ä½ç½®ã®ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
          smoothPosition(userLat, userLon);
          
          document.getElementById('gps-status').innerHTML = '<span class="ok">OK</span>';
          document.getElementById('position').textContent = 
            `${smoothedLat.toFixed(6)}, ${smoothedLon.toFixed(6)}`;
          
          const gpsButton = document.getElementById('gps-button');
          if (!gpsButton.disabled) {
            gpsButton.innerHTML = 'âœ… ä½ç½®æƒ…å ±å–å¾—å®Œäº†';
            gpsButton.disabled = true;
            document.getElementById('gyro-button').disabled = false;
            showMessage('ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
          }
        }, (err) => {
          document.getElementById('gps-status').innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼</span>';
          showMessage('GPS ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
        }, { 
          enableHighAccuracy: true, 
          maximumAge: 0,
          timeout: 10000
        });
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚’è¦æ±‚
    async function requestGyro() {
      if (typeof DeviceOrientationEvent !== 'undefined') {
        
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          try {
            showMessage('ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’æ±‚ã‚ã¦ã„ã¾ã™...', 'success');
            
            const permission = await DeviceOrientationEvent.requestPermission();
            
            if (permission === 'granted') {
              showMessage('ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼', 'success');
              document.getElementById('gyro-button').innerHTML = 'âœ… ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼æœ‰åŠ¹åŒ–å®Œäº†';
              document.getElementById('gyro-button').disabled = true;
              document.getElementById('close-button').disabled = false;
              
              startOrientation();
            } else {
              showMessage('âš ï¸ ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚', 'error');
            }
          } catch (err) {
            showMessage('ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
          }
        } else {
          showMessage('ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...', 'success');
          startOrientation();
          document.getElementById('gyro-button').innerHTML = 'âœ… ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼æœ‰åŠ¹åŒ–å®Œäº†';
          document.getElementById('gyro-button').disabled = true;
          document.getElementById('close-button').disabled = false;
        }
      }
    }

    // ã‚¸ãƒ£ã‚¤ãƒ­ã‚»ãƒ³ã‚µãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function startOrientation() {
      window.addEventListener('deviceorientationabsolute', (event) => {
        if (event.absolute && event.alpha !== null) {
          const rawHeading = 360 - event.alpha;
          heading = smoothHeading(rawHeading);
          headingAvailable = true;
          document.getElementById('heading').innerHTML = 
            `<span class="ok">${Math.round(smoothedHeading)}</span>`;
        }
      });
      
      window.addEventListener('deviceorientation', (event) => {
        if (event.alpha !== null && !headingAvailable) {
          const rawHeading = 360 - event.alpha;
          heading = smoothHeading(rawHeading);
          document.getElementById('heading').innerHTML = 
            `<span class="warn">${Math.round(smoothedHeading)}</span>`;
        }
      });
      
      setTimeout(() => {
        if (!headingAvailable && (smoothedHeading === null || smoothedHeading === 0)) {
          document.getElementById('heading').innerHTML = '<span class="err">å–å¾—å¤±æ•—</span>';
          showMessage('âš ï¸ æ–¹ä½æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚', 'error');
        }
      }, 3000);
    }

    // ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¦ARã‚’é–‹å§‹
    function closePanel() {
      document.getElementById('button-panel').style.display = 'none';
      startAR();
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showMessage(message, type) {
      const statusElem = document.getElementById('status-message');
      statusElem.textContent = message;
      statusElem.className = type;
    }

    // ARæç”»ãƒ«ãƒ¼ãƒ—
    function startAR() {
      function draw() {
        if (!smoothedLat || !smoothedLon || !posterImage || smoothedHeading === null) {
          requestAnimationFrame(draw);
          return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        let visibleCount = 0;

        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸä½ç½®ã¨æ–¹ä½ã‚’ä½¿ç”¨
        const currentLat = smoothedLat;
        const currentLon = smoothedLon;
        const currentHeading = smoothedHeading;

        // id13ã¨id14ã¾ã§ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        const poster13 = posters.find(p => p.id === 13);
        const poster14 = posters.find(p => p.id === 14);
        const poster15 = posters.find(p => p.id === 15);
        
        if (poster13) {
          const dist13 = degreeToMeter(calculateDistanceDegree(currentLat, currentLon, poster13.lat, poster13.lon));
          document.getElementById('dist-13').textContent = Math.round(dist13);
        }
        
        if (poster14) {
          const dist14 = degreeToMeter(calculateDistanceDegree(currentLat, currentLon, poster14.lat, poster14.lon));
          document.getElementById('dist-14').textContent = Math.round(dist14);
        }

        if (poster15) {
          const dist15 = degreeToMeter(calculateDistanceDegree(currentLat, currentLon, poster15.lat, poster15.lon));
          document.getElementById('dist-15').textContent = Math.round(dist15);
        }

        posters.forEach(poster => {
          const distanceDeg = calculateDistanceDegree(currentLat, currentLon, poster.lat, poster.lon);
          
          if (distanceDeg > DISPLAY_RANGE) return;
          
          const bearing = calculateBearing(currentLat, currentLon, poster.lat, poster.lon);
          
          let angleDiff = bearing - currentHeading;
          if (angleDiff > 180) angleDiff -= 360;
          if (angleDiff < -180) angleDiff += 360;

          const halfFOV = CAMERA_FOV / 2;
          if (Math.abs(angleDiff) < halfFOV) {
            visibleCount++;
            
            const screenX = centerX + (angleDiff / halfFOV) * (canvas.width / 2);
            
            const minScale = 0.5;
            const maxScale = 3.0;
            let scale = Math.max(minScale, Math.min(maxScale, (DISPLAY_RANGE * 0.8) / distanceDeg));
            
            // ãƒã‚¹ã‚¿ãƒ¼ã®å‘ãã«ã‚ˆã‚‹èª¿æ•´
            if (poster.facing !== null) {
              let viewAngle = (bearing + 180) % 360;
              let facingDiff = Math.abs(viewAngle - poster.facing);
              if (facingDiff > 180) facingDiff = 360 - facingDiff;
              
              const visibilityFactor = Math.cos(facingDiff * Math.PI / 180);
              
              if (Math.abs(facingDiff) > 60) return;
              
              scale *= Math.abs(visibilityFactor);
            }
            
            const posterWidth = 144 * scale;
            const posterHeight = 83 * scale;
            
            const eyeHeight = 1.6;
            const posterCenterHeight = poster.height;
            const distanceM = degreeToMeter(distanceDeg);
            const heightDiff = posterCenterHeight - eyeHeight;
            const verticalAngle = Math.atan2(heightDiff, distanceM) * 180 / Math.PI;
            const screenY = centerY - (verticalAngle / 30) * canvas.height / 2;
            
            ctx.save();
            const opacity = Math.max(0.8, Math.min(1.0, scale / 2.0));
            ctx.globalAlpha = opacity;
            
            ctx.drawImage(posterImage, 
              screenX - posterWidth / 2, 
              screenY - posterHeight / 2, 
              posterWidth, 
              posterHeight
            );
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç•ªå·ã¨è·é›¢
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = '#FFFF00';
            ctx.font = 'bold 20px sans-serif';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 4;
            const text = `${poster.id} (${Math.round(distanceM)}m)`;
            ctx.strokeText(text, screenX, screenY - posterHeight/2 - 10);
            ctx.fillText(text, screenX, screenY - posterHeight/2 - 10);
            
            ctx.restore();
          }
        });

        const countElem = document.getElementById('visible-count');
        countElem.textContent = visibleCount;
        countElem.className = visibleCount > 0 ? 'ok' : 'warn';

        requestAnimationFrame(draw);
      }

      draw();
    }

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>
